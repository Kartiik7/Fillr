<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard — Fillr</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
  <script src="env.js"></script>
</head>
<body>

  <!-- ── Toast ─────────────────────────────────────────────── -->
  <div class="db-toast" id="toast">
    <span class="toast-icon" id="toastIcon"></span>
    <span id="toastMsg"></span>
  </div>

  <!-- ── Nav ───────────────────────────────────────────────── -->
  <nav class="db-nav">
    <div class="db-nav-inner">
      <a class="db-brand" href="#">Fillr<span class="dot">.</span><span class="tag">beta</span></a>
      <div class="db-user">
        <button class="db-user-btn" id="userMenuBtn" aria-label="User menu">
          <span class="db-avatar" id="navAvatar">?</span>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="db-user-menu" id="userMenu">
          <div class="db-user-menu-email" id="menuEmail">—</div>
          <hr>
          <button class="logout-btn" onclick="logout()">Sign out</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- ── Hero / Progress ───────────────────────────────────── -->
  <div class="db-hero">
    <div class="db-hero-inner">
      <div class="db-hero-meta">
        <div class="db-avatar-lg" id="heroAvatar">?</div>
        <div>
          <div class="db-hero-name" id="heroName">—</div>
          <div class="db-hero-email" id="heroEmail">—</div>
        </div>
      </div>
      <div class="db-progress">
        <div class="db-progress-meta">
          <span>Profile completion</span>
          <span id="progressPct">0%</span>
        </div>
        <div class="db-progress-track">
          <div class="db-progress-fill" id="progressFill" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Main ──────────────────────────────────────────────── -->
  <main class="db-main">
    <form id="profileForm" novalidate>

      <!-- Card: Personal -->
      <div class="db-card is-open" id="card-personal">
        <div class="db-card-hdr" data-target="card-personal">
          <div class="db-card-hdr-left">
            <span class="db-card-icon">👤</span>
            <div>
              <div class="db-card-title">Personal Information</div>
              <div class="db-card-summary">Name, contact, identity and address details</div>
            </div>
          </div>
          <div class="db-card-hdr-right">
            <span class="db-card-badge" id="badge-personal">0 / 7</span>
            <svg class="db-card-chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
        </div>
        <div class="db-card-body">
          <div class="db-card-body-inner">
            <div class="db-field-grid cols-3">
              <!-- UID -->
              <div class="db-fl">
                <input class="db-fl-input" type="text" id="uid" name="uid" placeholder=" " autocomplete="off">
                <label class="db-fl-label" for="uid">University / College ID <span style="color:var(--danger)">*</span></label>
                <div class="db-fl-bar"></div>
                <div class="db-fl-error" id="uid-err"></div>
              </div>
              <!-- Full name -->
              <div class="db-fl">
                <input class="db-fl-input" type="text" id="name" name="name" placeholder=" " autocomplete="name">
                <label class="db-fl-label" for="name">Full Name <span style="color:var(--danger)">*</span></label>
                <div class="db-fl-bar"></div>
                <div class="db-fl-error" id="name-err"></div>
              </div>
              <!-- Email (read-only) -->
              <div class="db-fl">
                <input class="db-fl-input" type="email" id="email" name="email" placeholder=" " disabled>
                <label class="db-fl-label" for="email">Email Address</label>
                <div class="db-fl-bar"></div>
              </div>
              <!-- Phone -->
              <div class="db-fl">
                <input class="db-fl-input" type="tel" id="phone" name="phone" placeholder=" " maxlength="10" autocomplete="tel">
                <label class="db-fl-label" for="phone">Phone Number</label>
                <div class="db-fl-bar"></div>
                <div class="db-fl-error" id="phone-err"></div>
              </div>
              <!-- Date of Birth -->
              <div class="db-fl">
                <input class="db-fl-input" type="date" id="dob" name="dob" placeholder=" ">
                <label class="db-fl-label" for="dob">Date of Birth</label>
                <div class="db-fl-bar"></div>
              </div>
              <!-- Age -->
              <div class="db-fl">
                <input class="db-fl-input" type="number" id="age" name="age" placeholder=" " min="15" max="60">
                <label class="db-fl-label" for="age">Age</label>
                <div class="db-fl-bar"></div>
              </div>
              <!-- Gender -->
              <div class="db-fl">
                <select class="db-fl-select" id="gender" name="gender" onchange="syncSelectLabel(this)">
                  <option value=""></option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                  <option value="Prefer not to say">Prefer not to say</option>
                </select>
                <label class="db-fl-label" for="gender">Gender</label>
                <div class="db-fl-bar"></div>
              </div>
              <!-- Address -->
              <div class="db-fl db-col-full">
                <textarea class="db-fl-textarea" id="permanent_address" name="permanent_address" placeholder=" " rows="2"></textarea>
                <label class="db-fl-label" for="permanent_address">Permanent Address</label>
                <div class="db-fl-bar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Academic -->
      <div class="db-card" id="card-academic">
        <div class="db-card-hdr" data-target="card-academic">
          <div class="db-card-hdr-left">
            <span class="db-card-icon">📚</span>
            <div>
              <div class="db-card-title">Academic Records</div>
              <div class="db-card-summary">School, graduation and post-graduation percentages</div>
            </div>
          </div>
          <div class="db-card-hdr-right">
            <span class="db-card-badge" id="badge-academic">0 / 6</span>
            <svg class="db-card-chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
        </div>
        <div class="db-card-body">
          <div class="db-card-body-inner">
            <!-- Sub-group: School -->
            <div class="db-group">
              <div class="db-group-label">School Qualifications</div>
              <div class="db-field-grid cols-3">
                <div class="db-fl">
                  <input class="db-fl-input" type="number" id="tenth_percentage" name="tenth_percentage" placeholder=" " min="0" max="100" step="0.01">
                  <label class="db-fl-label" for="tenth_percentage">10th Percentage</label>
                  <div class="db-fl-bar"></div>
                  <div class="db-fl-suffix">%</div>
                  <div class="db-fl-error" id="tenth_percentage-err"></div>
                </div>
                <div class="db-fl">
                  <input class="db-fl-input has-suffix" type="number" id="twelfth_percentage" name="twelfth_percentage" placeholder=" " min="0" max="100" step="0.01">
                  <label class="db-fl-label" for="twelfth_percentage">12th Percentage</label>
                  <div class="db-fl-bar"></div>
                  <div class="db-fl-suffix">%</div>
                  <div class="db-fl-error" id="twelfth_percentage-err"></div>
                </div>
                <div class="db-fl">
                  <input class="db-fl-input has-suffix" type="number" id="diploma_percentage" name="diploma_percentage" placeholder=" " min="0" max="100" step="0.01">
                  <label class="db-fl-label" for="diploma_percentage">Diploma Percentage</label>
                  <div class="db-fl-bar"></div>
                  <div class="db-fl-suffix">%</div>
                  <div class="db-fl-error" id="diploma_percentage-err"></div>
                </div>
              </div>
            </div>
            <!-- Sub-group: Graduation -->
            <div class="db-group">
              <div class="db-group-label">Graduation</div>
              <div class="db-field-grid cols-3">
                <div class="db-fl">
                  <input class="db-fl-input has-suffix" type="number" id="graduation_percentage" name="graduation_percentage" placeholder=" " min="0" max="100" step="0.01">
                  <label class="db-fl-label" for="graduation_percentage">Graduation Percentage</label>
                  <div class="db-fl-bar"></div>
                  <div class="db-fl-suffix">%</div>
                  <div class="db-fl-error" id="graduation_percentage-err"></div>
                </div>
                <div class="db-fl">
                  <input class="db-fl-input" type="number" id="cgpa" name="cgpa" placeholder=" " min="0" max="10" step="0.01">
                  <label class="db-fl-label" for="cgpa">CGPA (out of 10)</label>
                  <div class="db-fl-bar"></div>
                  <div class="db-fl-error" id="cgpa-err"></div>
                </div>
              </div>
            </div>
            <!-- Sub-group: PG -->
            <div class="db-group">
              <div class="db-group-label">Post Graduation</div>
              <div class="db-field-grid cols-3">
                <div class="db-fl">
                  <input class="db-fl-input has-suffix" type="number" id="pg_percentage" name="pg_percentage" placeholder=" " min="0" max="100" step="0.01">
                  <label class="db-fl-label" for="pg_percentage">PG Percentage</label>
                  <div class="db-fl-bar"></div>
                  <div class="db-fl-suffix">%</div>
                  <div class="db-fl-error" id="pg_percentage-err"></div>
                </div>
              </div>
            </div>
            <!-- Sub-group: Backlogs -->
            <div class="db-group">
              <div class="db-group-label">Backlogs &amp; Gap</div>
              <div class="db-field-grid cols-3">
                <div class="db-fl">
                  <select class="db-fl-select" id="active_backlog" name="active_backlog" onchange="syncSelectLabel(this)">
                    <option value=""></option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                  <label class="db-fl-label" for="active_backlog">Active Backlog?</label>
                  <div class="db-fl-bar"></div>
                </div>
                <div class="db-fl">
                  <select class="db-fl-select" id="backlog_count" name="backlog_count" onchange="syncSelectLabel(this)">
                    <option value=""></option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5+</option>
                  </select>
                  <label class="db-fl-label" for="backlog_count">Backlog Count</label>
                  <div class="db-fl-bar"></div>
                </div>
                <div class="db-fl">
                  <select class="db-fl-select" id="gap_months" name="gap_months" onchange="syncSelectLabel(this)">
                    <option value=""></option>
                    <option value="0">0 months</option>
                    <option value="1">1 month</option>
                    <option value="2">2 months</option>
                    <option value="3">3 months</option>
                    <option value="6">6 months</option>
                    <option value="12">12 months</option>
                    <option value="24">24+ months</option>
                  </select>
                  <label class="db-fl-label" for="gap_months">Gap (months)</label>
                  <div class="db-fl-bar"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Education -->
      <div class="db-card" id="card-education">
        <div class="db-card-hdr" data-target="card-education">
          <div class="db-card-hdr-left">
            <span class="db-card-icon">🏫</span>
            <div>
              <div class="db-card-title">Education Details</div>
              <div class="db-card-summary">College, program, stream and batch</div>
            </div>
          </div>
          <div class="db-card-hdr-right">
            <span class="db-card-badge" id="badge-education">0 / 4</span>
            <svg class="db-card-chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
        </div>
        <div class="db-card-body">
          <div class="db-card-body-inner">
            <div class="db-field-grid cols-3">
              <div class="db-fl db-col-full">
                <input class="db-fl-input" type="text" id="college_name" name="college_name" placeholder=" " autocomplete="off">
                <label class="db-fl-label" for="college_name">College / University Name</label>
                <div class="db-fl-bar"></div>
              </div>
              <div class="db-fl">
                <select class="db-fl-select" id="program" name="program" onchange="syncSelectLabel(this)">
                  <option value=""></option>
                  <option value="B.E">B.E</option>
                  <option value="B.E+M.E (Integrated)">B.E+M.E (Integrated)</option>
                  <option value="B.Tech">B.Tech</option>
                  <option value="BCA">BCA</option>
                  <option value="BCS">BCS</option>
                  <option value="MCA">MCA</option>
                  <option value="M.Tech">M.Tech</option>
                  <option value="MBA">MBA</option>
                  <option value="B.Sc">B.Sc</option>
                  <option value="M.Sc">M.Sc</option>
                  <option value="Other">Other</option>
                </select>
                <label class="db-fl-label" for="program">Program / Degree</label>
                <div class="db-fl-bar"></div>
              </div>
              <div class="db-fl">
                <select class="db-fl-select" id="stream" name="stream" onchange="syncSelectLabel(this)">
                  <option value=""></option>
                  <option value="CSE">CSE (Computer Science)</option>
                  <option value="CSBS">CSBS</option>
                  <option value="AIML">AIML</option>
                  <option value="BDA">BDA</option>
                  <option value="CC">CC (Cloud Computing)</option>
                  <option value="IoT">IoT</option>
                  <option value="IS">IS (Information Security)</option>
                  <option value="Blockchain">Blockchain</option>
                  <option value="Devops">Devops</option>
                  <option value="GG">GG</option>
                  <option value="IT">Information Technology</option>
                  <option value="ECE">Electronics (ECE)</option>
                  <option value="ME">Mechanical</option>
                  <option value="CE">Civil</option>
                  <option value="EE">Electrical</option>
                  <option value="Other">Other</option>
                </select>
                <label class="db-fl-label" for="stream">Branch / Stream</label>
                <div class="db-fl-bar"></div>
              </div>
              <div class="db-fl">
                <select class="db-fl-select" id="batch" name="batch" onchange="syncSelectLabel(this)">
                  <option value=""></option>
                  <option value="2023">2023</option>
                  <option value="2024">2024</option>
                  <option value="2025">2025</option>
                  <option value="2026">2026</option>
                  <option value="2027">2027</option>
                  <option value="2028">2028</option>
                  <option value="2029">2029</option>
                </select>
                <label class="db-fl-label" for="batch">Graduation Batch</label>
                <div class="db-fl-bar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Placement & Links -->
      <div class="db-card" id="card-placement">
        <div class="db-card-hdr" data-target="card-placement">
          <div class="db-card-hdr-left">
            <span class="db-card-icon">🔗</span>
            <div>
              <div class="db-card-title">Placement &amp; Links</div>
              <div class="db-card-summary">Job preferences and professional profiles</div>
            </div>
          </div>
          <div class="db-card-hdr-right">
            <span class="db-card-badge" id="badge-placement">0 / 6</span>
            <svg class="db-card-chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
        </div>
        <div class="db-card-body">
          <div class="db-card-body-inner">
            <div class="db-field-grid cols-3">
              <div class="db-fl db-col-full">
                <select class="db-fl-select" id="position_applying" name="position_applying" onchange="syncSelectLabel(this)">
                  <option value=""></option>
                  <option value="Software Engineer">Software Engineer</option>
                  <option value="Data Analyst">Data Analyst</option>
                  <option value="Data Scientist">Data Scientist</option>
                  <option value="Product Manager">Product Manager</option>
                  <option value="UI/UX Designer">UI/UX Designer</option>
                  <option value="DevOps Engineer">DevOps Engineer</option>
                  <option value="Business Analyst">Business Analyst</option>
                  <option value="QA Engineer">QA Engineer</option>
                  <option value="Cloud Engineer">Cloud Engineer</option>
                  <option value="Cybersecurity Analyst">Cybersecurity Analyst</option>
                  <option value="ML Engineer">ML Engineer</option>
                  <option value="Full Stack Developer">Full Stack Developer</option>
                  <option value="Other">Other</option>
                </select>
                <label class="db-fl-label" for="position_applying">Position Applying For</label>
                <div class="db-fl-bar"></div>
              </div>
              <div class="db-fl">
                <input class="db-fl-input" type="url" id="github" name="github" placeholder=" ">
                <label class="db-fl-label" for="github">GitHub Profile URL</label>
                <div class="db-fl-bar"></div>
                <div class="db-fl-url">github.com/username</div>
                <div class="db-fl-error" id="github-err"></div>
              </div>
              <div class="db-fl">
                <input class="db-fl-input" type="url" id="linkedin" name="linkedin" placeholder=" ">
                <label class="db-fl-label" for="linkedin">LinkedIn Profile URL</label>
                <div class="db-fl-bar"></div>
                <div class="db-fl-url">linkedin.com/in/username</div>
                <div class="db-fl-error" id="linkedin-err"></div>
              </div>
              <div class="db-fl db-col-full">
                <input class="db-fl-input" type="url" id="portfolio" name="portfolio" placeholder=" ">
                <label class="db-fl-label" for="portfolio">Portfolio / Website URL</label>
                <div class="db-fl-bar"></div>
                <div class="db-fl-error" id="portfolio-err"></div>
              </div>
              <div class="db-fl db-col-full">
                <input class="db-fl-input" type="url" id="resume" name="resume" placeholder=" ">
                <label class="db-fl-label" for="resume">Resume Link (Google Drive / Dropbox)</label>
                <div class="db-fl-bar"></div>
                <div class="db-fl-url">drive.google.com/file/d/...</div>
                <div class="db-fl-error" id="resume-err"></div>
              </div>
              <div class="db-fl db-col-full">
                <input class="db-fl-input" type="text" id="job_location" name="job_location" placeholder=" ">
                <label class="db-fl-label" for="job_location">Job Location Preference</label>
                <div class="db-fl-bar"></div>
                <div class="db-fl-hint">e.g., Anywhere, Remote, Bangalore, Delhi NCR</div>
                <div class="db-fl-error" id="job_location-err"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Bar -->
      <div class="db-save-bar">
        <button class="db-save-btn" type="submit" id="saveBtn" disabled>
          <span class="sp" id="saveSpinner"></span>
          <span class="btn-label" id="saveBtnLabel">Save Changes</span>
        </button>
        <span class="db-save-hint" id="saveHint">No unsaved changes</span>
      </div>

    </form>

    <!-- Extension Keys ───────────────────────── -->
    <div class="db-keys-section" id="keysSection">
      <div class="db-keys-hdr">
        <div>
          <div class="db-keys-title">🔑 Extension Secret Keys</div>
          <p class="db-keys-desc">Generate secret keys to connect the Fillr browser extension. Each key is shown <strong>once</strong>&nbsp;— copy it immediately.</p>
        </div>
        <button class="db-keys-gen-btn" id="openKeyGenModal" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Generate Key
        </button>
      </div>

      <div class="db-keys-list" id="keysList">
        <div class="db-keys-empty" id="keysEmpty">No extension keys yet. Generate one to get started.</div>
      </div>
    </div>

    <!-- Key Generation Modal ─────────────────── -->
    <div class="db-modal-backdrop" id="keyGenModalBackdrop" role="dialog" aria-modal="true" aria-labelledby="keyGenModalTitle">
      <div class="db-modal">
        <div class="db-modal-header">
          <span class="db-modal-icon">🔐</span>
          <h2 id="keyGenModalTitle">Generate Extension Key</h2>
        </div>
        <p class="db-modal-desc">Enter a name for this key (e.g. "Work laptop") and your password to confirm.</p>
        <div class="db-fl" style="margin: 16px 0 8px;">
          <input class="db-fl-input" type="text" id="keyDeviceName" placeholder=" " maxlength="100" autocomplete="off">
          <label class="db-fl-label" for="keyDeviceName">Device Name</label>
          <div class="db-fl-bar"></div>
        </div>
        <div class="db-fl" style="margin: 0 0 4px;">
          <input class="db-fl-input" type="password" id="keyGenPassword" placeholder=" " autocomplete="current-password">
          <label class="db-fl-label" for="keyGenPassword">Your Password</label>
          <div class="db-fl-bar"></div>
        </div>
        <div class="db-modal-err" id="keyGenErr" aria-live="polite"></div>
        <div class="db-modal-actions">
          <button class="db-modal-cancel" id="cancelKeyGen" type="button">Cancel</button>
          <button class="db-modal-confirm" id="confirmKeyGen" type="button" style="background:var(--blue);">Generate</button>
        </div>
      </div>
    </div>

    <!-- Key Display Modal (shown once after generation) ──── -->
    <div class="db-modal-backdrop" id="keyDisplayBackdrop" role="dialog" aria-modal="true" aria-labelledby="keyDisplayTitle">
      <div class="db-modal" style="max-width:520px;">
        <div class="db-modal-header">
          <span class="db-modal-icon">✅</span>
          <h2 id="keyDisplayTitle">Key Generated</h2>
        </div>
        <p class="db-modal-desc"><strong>Copy this key now.</strong> It will not be shown again.</p>
        <div class="db-key-display">
          <code id="keyDisplayValue">—</code>
          <button class="db-key-copy-btn" id="copyKeyBtn" type="button" title="Copy to clipboard">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          </button>
        </div>
        <div class="db-modal-actions" style="margin-top:16px;">
          <button class="db-modal-cancel" id="closeKeyDisplay" type="button">Done</button>
        </div>
      </div>
    </div>

    <!-- Danger Zone ──────────────────────────── -->
    <div class="db-danger-zone">
      <div>
        <div class="db-danger-title">⚠️ Danger Zone</div>
        <p class="db-danger-desc">Permanently delete your account and all associated data.<br>This action <strong>cannot be undone</strong>.</p>
      </div>
      <button class="db-danger-btn" id="openDeleteModal" type="button">Delete My Account</button>
    </div>

  </main>

  <!-- Delete Account Modal ──────────────────── -->
  <div class="db-modal-backdrop" id="deleteModalBackdrop" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
    <div class="db-modal">
      <div class="db-modal-header">
        <span class="db-modal-icon">🗑</span>
        <h2 id="deleteModalTitle">Delete Account</h2>
      </div>
      <p class="db-modal-desc">
        This will <strong>permanently delete</strong> your account and all personal data stored by
        Fillr. Once confirmed, recovery is impossible.
      </p>
      <!-- Floating-label password field (matches dashboard style) -->
      <div class="db-fl" style="margin: 20px 0 4px;">
        <input class="db-fl-input" type="password" id="deletePassword" placeholder=" " autocomplete="current-password">
        <label class="db-fl-label" for="deletePassword">Confirm your password</label>
        <div class="db-fl-bar"></div>
      </div>
      <div class="db-modal-err" id="deleteErr" aria-live="polite"></div>
      <div class="db-modal-actions">
        <button class="db-modal-cancel" id="cancelDelete" type="button">Cancel</button>
        <button class="db-modal-confirm" id="confirmDelete" type="button">Delete Permanently</button>
      </div>
    </div>
  </div>

  <div class="db-legal-footer">
    <a href="terms.html">Terms &amp; Conditions</a>
    <a href="privacy.html">Privacy Policy</a>
  </div>

  <script>
  /* ── Helpers ─────────────────────────────────────────────── */
  const API_URL = ENV.API_URL || 'https://fillr-gqyp.onrender.com/api';
  const $ = id => document.getElementById(id);
  const v = id => ($(''+id)?.value || '').trim();

  function showToast(msg, type = 'success') {
    const t = $('toast');
    $('toastMsg').textContent = msg;
    $('toastIcon').textContent = type === 'success' ? '✓' : '✕';
    t.className = 'db-toast show toast-' + type;
    clearTimeout(t._timer);
    t._timer = setTimeout(() => { t.className = 'db-toast'; }, 3600);
  }

  /* ── Card toggle ─────────────────────────────────────────── */
  document.querySelectorAll('.db-card-hdr').forEach(hdr => {
    hdr.addEventListener('click', () => {
      const card = document.getElementById(hdr.dataset.target);
      if (card) card.classList.toggle('is-open');
    });
  });

  function openCard(fieldId) {
    const field = $(fieldId);
    if (!field) return;
    const card = field.closest('.db-card');
    if (card) card.classList.add('is-open');
  }

  /* ── User menu ───────────────────────────────────────────── */
  $('userMenuBtn').addEventListener('click', e => {
    e.stopPropagation();
    $('userMenu').classList.toggle('open');
  });
  document.addEventListener('click', () => $('userMenu').classList.remove('open'));

  /* ── Auth / Logout ───────────────────────────────────────── */
  function logout() {
    localStorage.removeItem('token');
    sessionStorage.removeItem('token');
    window.location.href = 'login.html';
  }

  /* ── Select floating label sync ──────────────────────────── */
  function syncSelectLabel(sel) {
    sel.closest('.db-fl').classList.toggle('has-value', sel.value !== '');
  }

  /* ── Dirty tracking ──────────────────────────────────────── */
  const ALL_FIELDS = [
    'uid','name','phone','dob','age','gender','permanent_address',
    'tenth_percentage','twelfth_percentage','diploma_percentage',
    'graduation_percentage','cgpa','pg_percentage',
    'active_backlog','backlog_count','gap_months',
    'college_name','program','stream','batch',
    'position_applying','job_location','github','linkedin','portfolio','resume'
  ];

  let _snapshot = '';

  function getSnapshot() {
    return ALL_FIELDS.map(id => v(id)).join('|');
  }

  function setDirty(dirty) {
    $('saveBtn').disabled = !dirty;
    const hint = $('saveHint');
    hint.textContent = dirty ? 'You have unsaved changes' : 'No unsaved changes';
    hint.style.color = dirty ? 'var(--amber)' : 'var(--muted)';
  }

  function checkDirty() {
    setDirty(getSnapshot() !== _snapshot);
    updateCompletion();
  }

  ALL_FIELDS.forEach(id => {
    const el = $(id);
    if (!el) return;
    el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', checkDirty);
  });

  /* ── Completion calc ─────────────────────────────────────── */
  const COMPLETION_FIELDS = [
    'uid','name','phone','gender','dob',
    'tenth_percentage','twelfth_percentage','graduation_percentage','cgpa',
    'college_name','batch','program','stream','position_applying'
  ];

  const CARD_FIELDS = {
    personal:   ['uid','name','phone','gender','dob','age','permanent_address'],
    academic:   ['tenth_percentage','twelfth_percentage','graduation_percentage','cgpa','pg_percentage','gap_months'],
    education:  ['college_name','program','stream','batch'],
    placement:  ['position_applying','job_location','github','linkedin','portfolio','resume']
  };

  function fieldFilled(id) {
    const val = v(id);
    return val !== '' && val !== '0' && val !== 'false';
  }

  function updateCompletion() {
    const filled = COMPLETION_FIELDS.filter(fieldFilled).length;
    const pct = Math.round((filled / COMPLETION_FIELDS.length) * 100);
    $('progressFill').style.width = pct + '%';
    $('progressFill').classList.toggle('complete', pct === 100);
    $('progressPct').textContent = pct + '%';

    // Per-card badges
    Object.entries(CARD_FIELDS).forEach(([card, fields]) => {
      const done = fields.filter(fieldFilled).length;
      const badge = $('badge-' + card);
      if (!badge) return;
      badge.textContent = done + ' / ' + fields.length;
      badge.className = 'db-card-badge' + (done === fields.length ? ' complete' : done > 0 ? ' partial' : '');
    });

    // Hero name + avatar
    const nm = v('name') || '—';
    $('heroName').textContent = nm;
    const initials = nm.split(' ').filter(Boolean).slice(0,2).map(w => w[0].toUpperCase()).join('');
    $('heroAvatar').textContent = initials || '?';
    $('navAvatar').textContent = (initials || '?')[0];
  }

  /* ── Validation ──────────────────────────────────────────── */
  function setFieldError(id, msg) {
    const el = $(id);
    if (!el) return;
    el.classList.add('is-error');
    el.classList.remove('is-valid');
    const err = $(id + '-err');
    if (err) { err.textContent = msg; err.style.display = 'block'; }
    el.animate([{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],
      {duration: 320, iterations: 2});
  }

  function clearFieldError(id) {
    const el = $(id);
    if (!el) return;
    el.classList.remove('is-error');
    const err = $(id + '-err');
    if (err) { err.textContent = ''; err.style.display = 'none'; }
  }

  function setFieldValid(id) {
    const el = $(id);
    if (!el) return;
    el.classList.remove('is-error');
    el.classList.add('is-valid');
  }

  function validateAll() {
    let ok = true;
    ALL_FIELDS.forEach(id => clearFieldError(id));

    function require(id, msg) {
      if (!fieldFilled(id)) { setFieldError(id, msg || 'Required'); openCard(id); ok = false; }
      else setFieldValid(id);
    }

    function range(id, min, max, label) {
      const val = parseFloat(v(id));
      if (v(id) === '') return;
      if (isNaN(val) || val < min || val > max) {
        setFieldError(id, `${label} must be ${min}–${max}`);
        openCard(id); ok = false;
      } else setFieldValid(id);
    }

    function urlCheck(id) {
      const el = $(id);
      if (!el || !v(id)) return;
      // Auto-prepend https:// if no protocol present
      if (!v(id).startsWith('http://') && !v(id).startsWith('https://')) {
        el.value = 'https://' + v(id);
      }
      setFieldValid(id);
    }

    require('uid', 'College/University ID is required');
    require('name', 'Full name is required');

    if (v('phone') && !/^\d{10}$/.test(v('phone'))) {
      setFieldError('phone', 'Must be exactly 10 digits');
      openCard('phone'); ok = false;
    } else if (v('phone')) setFieldValid('phone');

    ['tenth_percentage','twelfth_percentage','diploma_percentage',
     'graduation_percentage','pg_percentage'].forEach(id => range(id, 0, 100, 'Percentage'));
    range('cgpa', 0, 10, 'CGPA');

    urlCheck('github');
    urlCheck('linkedin');
    urlCheck('portfolio');

    return ok;
  }

  /* ── Load profile ────────────────────────────────────────── */
  async function loadProfile() {
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    if (!token) { window.location.href = 'login.html'; return; }

    try {
      const res = await fetch(API_URL + '/profile', { headers: { Authorization: 'Bearer ' + token } });
      if (res.status === 401) {
        // Clear stale token to prevent login ↔ dashboard redirect loop
        localStorage.removeItem('token');
        sessionStorage.removeItem('token');
        window.location.href = 'login.html';
        return;
      }
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Failed to load profile');

      const p = data.profile || {};
      const ps = p.personal || {};
      const ac = p.academics || {};
      const ed = p.education || {};
      const pl = p.placement || {};
      const lk = p.links || {};
      const ids = p.ids || {};

      function setValue(id, val) {
        const el = $(id);
        if (!el || val == null) return;
        el.value = val;
      }

      function setSelect(id, val) {
        const el = $(id);
        if (!el || val == null) return;
        el.value = String(val);
        syncSelectLabel(el);
      }

      setValue('uid', ids.uid);
      setValue('name', ps.name);
      setValue('email', data.email || ps.email);
      setValue('phone', ps.phone);
      setValue('dob', ps.dob);
      setValue('age', ps.age);
      setSelect('gender', ps.gender);
      setValue('permanent_address', ps.permanent_address);

      setValue('tenth_percentage', ac.tenth_percentage);
      setValue('twelfth_percentage', ac.twelfth_percentage);
      setValue('diploma_percentage', ac.diploma_percentage);
      setValue('graduation_percentage', ac.graduation_percentage);
      setValue('cgpa', ac.cgpa);
      setValue('pg_percentage', ac.pg_percentage);
      // Convert boolean/string to Yes/No for display
      const backlogVal = ac.active_backlog === true || ac.active_backlog === 'true' ? 'Yes' : 
                         ac.active_backlog === false || ac.active_backlog === 'false' ? 'No' : 
                         ac.active_backlog || '';
      setSelect('active_backlog', backlogVal);
      setSelect('backlog_count', ac.backlog_count != null ? ac.backlog_count : '');
      setSelect('gap_months', ac.gap_months != null ? ac.gap_months : '');

      setValue('college_name', ed.college_name);
      setSelect('program', ed.program);
      setSelect('stream', ed.stream);
      setSelect('batch', ed.batch);

      setSelect('position_applying', pl.position_applying);
      setValue('job_location', pl.job_location);
      setValue('github', lk.github);
      setValue('linkedin', lk.linkedin);
      setValue('portfolio', lk.portfolio);
      setValue('resume', lk.resume);

      // Set hero email / menu email
      const emailVal = data.email || ps.email || '';
      $('heroEmail').textContent = emailVal;
      $('menuEmail').textContent = emailVal;

      updateCompletion();
      _snapshot = getSnapshot();
      setDirty(false);
    } catch (err) {
      showToast(err.message || 'Could not load profile', 'error');
    }
  }

  /* ── Form submit ─────────────────────────────────────────── */
  $('profileForm').addEventListener('submit', async e => {
    e.preventDefault();
    if (!validateAll()) { showToast('Please fix the highlighted errors', 'error'); return; }

    const btn = $('saveBtn');
    btn.classList.add('is-loading');
    btn.disabled = true;

    const token = localStorage.getItem('token') || sessionStorage.getItem('token');

    const profileData = {
      profile: {
        personal: {
          name: v('name'),
          phone: v('phone'),
          dob: v('dob'),
          age: v('age') ? Number(v('age')) : undefined,
          gender: v('gender'),
          permanent_address: v('permanent_address')
        },
        academics: {
          tenth_percentage: v('tenth_percentage') !== '' ? Number(v('tenth_percentage')) : undefined,
          twelfth_percentage: v('twelfth_percentage') !== '' ? Number(v('twelfth_percentage')) : undefined,
          diploma_percentage: v('diploma_percentage') !== '' ? Number(v('diploma_percentage')) : undefined,
          graduation_percentage: v('graduation_percentage') !== '' ? Number(v('graduation_percentage')) : undefined,
          cgpa: v('cgpa') !== '' ? Number(v('cgpa')) : undefined,
          pg_percentage: v('pg_percentage') !== '' ? Number(v('pg_percentage')) : undefined,
          active_backlog: v('active_backlog') || undefined,
          backlog_count: v('backlog_count') !== '' ? Number(v('backlog_count')) : 0,
          gap_months: v('gap_months') !== '' ? Number(v('gap_months')) : 0
        },
        ids: { uid: v('uid') },
        education: {
          college_name: v('college_name'),
          program: v('program'),
          stream: v('stream'),
          batch: v('batch')
        },
        placement: { 
          position_applying: v('position_applying'),
          job_location: v('job_location')
        },
        links: {
          github: v('github'),
          linkedin: v('linkedin'),
          portfolio: v('portfolio'),
          resume: v('resume')
        }
      }
    };

    try {
      const res = await fetch(API_URL + '/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify(profileData)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Save failed');

      btn.classList.remove('is-loading');
      btn.classList.add('is-success');
      $('saveBtnLabel').textContent = 'Saved!';
      showToast('Profile saved successfully', 'success');
      _snapshot = getSnapshot();
      setDirty(false);
      setTimeout(() => {
        btn.classList.remove('is-success');
        $('saveBtnLabel').textContent = 'Save Changes';
      }, 2400);
    } catch (err) {
      btn.classList.remove('is-loading');
      btn.disabled = false;
      showToast(err.message || 'Save failed. Try again.', 'error');
    }
  });

  /* ── Delete Account Modal ───────────────────────────────── */
  (function () {
    const backdrop = $('deleteModalBackdrop');
    const pwInput  = $('deletePassword');
    const errEl    = $('deleteErr');
    const confirmBtn = $('confirmDelete');

    function openModal() {
      backdrop.classList.add('show');
      pwInput.value = '';
      errEl.textContent = '';
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Delete Permanently';
      setTimeout(() => pwInput.focus(), 80);
    }
    function closeModal() { backdrop.classList.remove('show'); }

    $('openDeleteModal').addEventListener('click', openModal);
    $('cancelDelete').addEventListener('click', closeModal);
    backdrop.addEventListener('click', e => { if (e.target === backdrop) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    confirmBtn.addEventListener('click', async () => {
      const pwd = pwInput.value;
      if (!pwd) { errEl.textContent = 'Password is required.'; return; }
      errEl.textContent = '';
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Deleting…';

      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      try {
        const res = await fetch(API_URL + '/user/delete', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify({ password: pwd }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Deletion failed.');
        // Clear all stored credentials and redirect to login
        localStorage.removeItem('token');
        sessionStorage.removeItem('token');
        window.location.href = 'login.html?deleted=1';
      } catch (err) {
        errEl.textContent = err.message;
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Delete Permanently';
      }
    });
  })();

  /* ── Extension Key Management ─────────────────────────────── */
  (function () {
    const listEl       = $('keysList');
    const emptyEl      = $('keysEmpty');
    const genBackdrop  = $('keyGenModalBackdrop');
    const genPwInput   = $('keyGenPassword');
    const deviceInput  = $('keyDeviceName');
    const genErr       = $('keyGenErr');
    const confirmGen   = $('confirmKeyGen');
    const dispBackdrop = $('keyDisplayBackdrop');
    const dispValue    = $('keyDisplayValue');

    function getToken() {
      return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    function fmtDate(iso) {
      if (!iso) return '—';
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function renderKeys(keys) {
      // Remove existing key rows (keep emptyEl)
      listEl.querySelectorAll('.db-key-row').forEach(r => r.remove());
      if (!keys || keys.length === 0) { emptyEl.style.display = ''; return; }
      emptyEl.style.display = 'none';

      keys.forEach(k => {
        const row = document.createElement('div');
        row.className = 'db-key-row' + (k.isActive ? '' : ' revoked');
        const expired = k.expiresAt && new Date(k.expiresAt) < new Date();
        const statusLabel = !k.isActive ? 'Revoked' : expired ? 'Expired' : 'Active';
        const statusCls   = !k.isActive ? 'revoked' : expired ? 'expired' : 'active';

        row.innerHTML = `
          <div class="db-key-info">
            <div class="db-key-name">${k.deviceName || 'Extension'}</div>
            <div class="db-key-meta">
              <span class="db-key-status ${statusCls}">${statusLabel}</span>
              <span>Created ${fmtDate(k.createdAt)}</span>
              <span>Expires ${fmtDate(k.expiresAt)}</span>
              ${k.lastUsedAt ? '<span>Last used ' + fmtDate(k.lastUsedAt) + '</span>' : ''}
            </div>
          </div>
          <div class="db-key-actions">
            ${k.isActive && !expired ? '<button class="db-key-revoke-btn" data-id="' + k.keyId + '">Revoke</button>' : ''}
          </div>`;
        listEl.appendChild(row);
      });

      // Bind revoke buttons
      listEl.querySelectorAll('.db-key-revoke-btn').forEach(btn => {
        btn.addEventListener('click', () => revokeKey(btn.dataset.id));
      });
    }

    async function loadKeys() {
      try {
        const res = await fetch(API_URL + '/keys', {
          headers: { Authorization: 'Bearer ' + getToken() }
        });
        if (res.status === 401) return;
        const data = await res.json();
        if (data.success) renderKeys(data.keys);
      } catch (_) { /* silent */ }
    }

    async function revokeKey(keyId) {
      if (!confirm('Revoke this extension key? The extension will need a new key to reconnect.')) return;
      try {
        const res = await fetch(API_URL + '/keys/revoke', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + getToken() },
          body: JSON.stringify({ keyId })
        });
        const data = await res.json();
        if (data.success) {
          showToast('Key revoked', 'success');
          loadKeys();
        } else {
          showToast(data.message || 'Failed to revoke key', 'error');
        }
      } catch (_) {
        showToast('Could not revoke key', 'error');
      }
    }

    // Generate modal
    function openGenModal() {
      genBackdrop.classList.add('show');
      genPwInput.value = '';
      deviceInput.value = '';
      genErr.textContent = '';
      confirmGen.disabled = false;
      confirmGen.textContent = 'Generate';
      setTimeout(() => deviceInput.focus(), 80);
    }
    function closeGenModal() { genBackdrop.classList.remove('show'); }

    $('openKeyGenModal').addEventListener('click', openGenModal);
    $('cancelKeyGen').addEventListener('click', closeGenModal);
    genBackdrop.addEventListener('click', e => { if (e.target === genBackdrop) closeGenModal(); });

    confirmGen.addEventListener('click', async () => {
      const pwd = genPwInput.value;
      if (!pwd) { genErr.textContent = 'Password is required.'; return; }
      genErr.textContent = '';
      confirmGen.disabled = true;
      confirmGen.textContent = 'Generating…';

      try {
        const res = await fetch(API_URL + '/keys/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + getToken() },
          body: JSON.stringify({ password: pwd, deviceName: deviceInput.value.trim() || undefined })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.message || 'Key generation failed.');

        closeGenModal();
        // Show the raw key
        dispValue.textContent = data.key.rawKey;
        dispBackdrop.classList.add('show');
        loadKeys();
      } catch (err) {
        genErr.textContent = err.message;
        confirmGen.disabled = false;
        confirmGen.textContent = 'Generate';
      }
    });

    // Display modal
    $('copyKeyBtn').addEventListener('click', () => {
      navigator.clipboard.writeText(dispValue.textContent).then(() => {
        showToast('Key copied to clipboard', 'success');
      }).catch(() => {
        // Fallback: select text
        const range = document.createRange();
        range.selectNodeContents(dispValue);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        showToast('Select and copy the key above', 'error');
      });
    });
    $('closeKeyDisplay').addEventListener('click', () => { dispBackdrop.classList.remove('show'); });
    dispBackdrop.addEventListener('click', e => { if (e.target === dispBackdrop) dispBackdrop.classList.remove('show'); });

    // Initial load
    loadKeys();
  })();

  /* ── Boot ────────────────────────────────────────────────── */
  loadProfile();
  </script>
</body>
</html>
